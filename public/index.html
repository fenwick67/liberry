<!DOCTYPE html>
<html>

<head>
    <title>liberry</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script src="audioPlayer.js"></script>
    <script src="mediaBar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js" integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps=" crossorigin="anonymous"></script>
    <style>
      .thumbnail{
        width:100px;
        height:100px;
      }
    </style>
    <div id="app">
      <media-bar ref="player"></media-bar>
      <hr>
      <input type="text" placeholder="search" v-model=query @keyup.enter="sendQuery"></input>
      <button @click="sendQuery">search</button>
      <br>
      Artists:
      <ul>
        <li v-for="artist in results.artists">
          {{artist.name}}
          <button @click="playSet(artist)">play</button>
          <button @click="enqueueSet(artist)">enqueue</button>
        </li>
      </ul>
      Albums:
      <button @click="getRandomAlbums()">random</button>
      <ul>
        <li v-for="track in results.albums">
          <img class="thumbnail" :src="track.artUrl" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQI12NgYAAAAAMAASDVlMcAAAAASUVORK5CYII='"></img>
          {{track.album}}
          <button @click="playAlbumByTitle(track.album)">play</button>
          <button @click="enqueueAlbumByTitle(track.album)">enqueue</button>
        </li>
      </ul>
      Tracks:
      <ul>
        <li v-for="track in results.tracks">
          {{track.title}} by {{track.artist}} on {{track.album}}
          <button @click="playTrack(track)">play</button>
          <button @click="enqueueTrack(track)">enqueue</button>
        </li>
      </ul>
    </div>
    <div id='webamp-app'>
        <!-- Webamp will attempt to center itself within this div -->
    </div>
    <script>

        const app = new Vue({
          el:"#app",
          data:{
            query:'',
            results:{
              albums:[],
              tracks:[]
            }
          },
          methods:{
            playSet(a){
              return this.playTracks(a.tracks);
            },
            enqueueSet(a){
              return this.enqueueTracks(a.tracks);
            },
            playTrack(t){
              return this.playTracks([t]);
            },
            enqueueTrack(t){
              return this.enqueueTracks([t]);
            },
            playTracks(ts){
              this.$refs.player.setPlaylist(ts,true);
            },
            enqueueTracks(ts){
              this.$refs.player.enqueue(ts);
            },
            getRandomAlbums(){
              window.fetch('/api/randomAlbums?count=5',{credentials:'same-origin'})
              .then(res=>res.json())
              .then(tracks=>{
                this.results.albums = tracks.map(track=>{
                    return {
                      album:track.album,
                      artist:track.artist,
                      artUrl:track.artUrl,
                      tracks:null
                    }
                  });

              })
            },
            sendQuery(){
              let q = this.query || '.';

              window.fetch('/api/search?q='+q+'&skip=0&limit=100000',{credentials:'same-origin'})
              .then(res=> res.json())
              .then(tracks=>{

                this.results.tracks = tracks;

                let stringFilter = (q == '.')?'':q.toLowerCase();

                let albums = _.groupBy(tracks,'album');
                this.results.albums = Object.keys(albums)
                  .filter(albumTitle=>{ // only albums which either match, OR, the first track's artist matches
                    return albumTitle.toLowerCase().indexOf(stringFilter) > -1 ||
                      (albums[albumTitle][0] && albums[albumTitle][0].artist &&  albums[albumTitle][0].artist.toLowerCase().indexOf(stringFilter) > -1 )
                  })
                  .map(albumTitle=>{
                    return {
                      artUrl:albums[albumTitle][0].artUrl,
                      album:albumTitle,
                      tracks:_.sortBy(albums[albumTitle],function(t){
                        return (t.disc||0)*100 + t.trackNumber;
                      })
                    }
                  });

                let artists = _.groupBy(tracks,'artist');
                this.results.artists = Object.keys(artists)
                  .filter(artistName=>{
                    return artistName.toLowerCase().indexOf(stringFilter) > -1
                  })
                  .map(artistName=>{
                    return {
                      name:artistName,
                      tracks:artists[artistName]
                    }
                  });

              })
              .catch(e=>alert(e))

            },
            playAlbumByTitle:function(title){
              window.fetch('/api/album?title='+title,{credentials:'same-origin'})
                .then(res=> res.json())
                .then(tracks=>{
                  let sorted = _.sortBy(tracks,t=>(t.disc||0)*100 + t.trackNumber);
                  this.playTracks(sorted);
                });
            },
            enqueueAlbumByTitle:function(title){
              window.fetch('/api/album?title='+title,{credentials:'same-origin'})
                .then(res=> res.json())
                .then(tracks=>{
                  this.playTracks(tracks);
                });
            }

          },
          created:function(){

            this.getRandomAlbums();

          }

        })


    </script>
</body>

</html>
